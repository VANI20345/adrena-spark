# ุฅุตูุงุญุงุช ูุธุงู ุงููุฌููุนุงุช - ููุชูู โ

## ุชุงุฑูุฎ ุงูุชุญุฏูุซ: 2025-10-04

---

## ๐ฏ ุงููุดุงูู ุงูุชู ุชู ุญููุง

### 1. โ ุนุฏู ุงููุฏุฑุฉ ุนูู ุงูุฏุฎูู ูููุฌููุนุงุช ุงูุนุงูุฉ
**ุงููุดููุฉ**: ุงููุณุชุฎุฏููู ูุง ูุณุชุทูุนูู ุงููุตูู ูููุฌููุนุงุช ุงูุฅูููููุฉ ุฃู ุงููุชุงุจุฉ ูููุง.

**ุงูุญู**:
- ุชุญุฏูุซ ุณูุงุณุงุช RLS ูุฌุฏูู `event_groups` ููุณูุงุญ ูุฌููุน ุงููุณุชุฎุฏููู ุงููุณุฌููู ุจุฑุคูุฉ ุงููุฌููุนุงุช
- ุชุญุฏูุซ ุณูุงุณุงุช RLS ูุฌุฏูู `group_members` ููุณูุงุญ ุจุงูุงูุถูุงู ุจุณูููุฉ
- ุชุญุฏูุซ ุณูุงุณุงุช RLS ูุฌุฏูู `group_messages` ููุณูุงุญ ุจุงููุชุงุจุฉ ูุฃุนุถุงุก ุงููุฌููุนุฉ ููุท

### 2. โ ุนุฏู ุธููุฑ ูุฌููุนุฉ ุงููุนุงููุฉ ุนูุฏ ุฅูุดุงุฆูุง
**ุงููุดููุฉ**: ุนูุฏ ุฅูุดุงุก ูุนุงููุฉ ุฌุฏูุฏุฉุ ูุง ุชุธูุฑ ูุฌููุนุชูุง ููููุธู.

**ุงูุญู**:
- ุชุญุฏูุซ trigger `setup_group_moderators` ูุฅุถุงูุฉ ุงูููุธู ุชููุงุฆูุงู ูุนุถู (owner) ูู ุงููุฌููุนุฉ
- ุฅุถุงูุฉ constraint unique ูููุน ุงูุชูุฑุงุฑ ูู `group_members`
- ุฅุถุงูุฉ ุฌููุน ุงูููุธููู ุงูุญุงูููู ูุฃุนุถุงุก ูู ูุฌููุนุงุชูู ุงูููุฌูุฏุฉ

### 3. โ ุนุฏู ุงููุฏุฑุฉ ุนูู ุงููุชุงุจุฉ ูู ุงููุฌููุนุงุช
**ุงููุดููุฉ**: ุงููุณุชุฎุฏููู ูุง ูุณุชุทูุนูู ุฅุฑุณุงู ุฑุณุงุฆู ูู ุงููุฌููุนุงุช.

**ุงูุญู**:
- ุชุจุณูุท ุณูุงุณุงุช RLS ูู `group_messages` ูุชุชุญูู ููุท ูู ุงูุนุถููุฉ ูู `group_members`
- ุฅุฒุงูุฉ ุงูุดุฑุท ุงููุนูุฏ ุงูุฐู ูุชุทูุจ ุญุฌุฒ ูุคูุฏ ูููุนุงููุฉ
- ุงูุณูุงุญ ุจุงููุชุงุจุฉ ูู ุงููุฌููุนุงุช ุงูุฅูููููุฉ ูุงููุฌููุนุงุช ุงูุนุงุฏูุฉ

---

## ๐ง ุงูุชุบููุฑุงุช ุงูุชูููุฉ ุงููุทุจูุฉ

### 1. ูุงุนุฏุฉ ุงูุจูุงูุงุช - ุณูุงุณุงุช RLS

#### ุฌุฏูู `event_groups`:
```sql
-- ุงูุณูุงุญ ูุฌููุน ุงููุณุชุฎุฏููู ุจุฑุคูุฉ ุงููุฌููุนุงุช
CREATE POLICY "Everyone can view event groups"
ON event_groups FOR SELECT TO authenticated
USING (true);
```

#### ุฌุฏูู `group_members`:
```sql
-- ุชุจุณูุท ุณูุงุณุฉ ุงูุงูุถูุงู
CREATE POLICY "Users can join groups"
ON group_members FOR INSERT TO authenticated
WITH CHECK (auth.uid() = user_id);
```

#### ุฌุฏูู `group_messages`:
```sql
-- ุงูุณูุงุญ ุจุงููุชุงุจุฉ ููุฃุนุถุงุก ููุท
CREATE POLICY "Group members can create messages"
ON group_messages FOR INSERT TO authenticated
WITH CHECK (
  auth.uid() = sender_id AND
  EXISTS (
    SELECT 1 FROM group_members gm
    WHERE gm.group_id = group_messages.group_id 
    AND gm.user_id = auth.uid()
  )
);

-- ุงูุณูุงุญ ุจูุฑุงุกุฉ ุงูุฑุณุงุฆู ููุฃุนุถุงุก ููุท
CREATE POLICY "Group members can view messages"
ON group_messages FOR SELECT TO authenticated
USING (
  EXISTS (
    SELECT 1 FROM group_members gm
    WHERE gm.group_id = group_messages.group_id 
    AND gm.user_id = auth.uid()
  )
);
```

### 2. Trigger ุงูุชููุงุฆู
```sql
-- ุฅุถุงูุฉ ุงูููุธู ุชููุงุฆูุงู ูุนุถู ูู ุงููุฌููุนุฉ
CREATE OR REPLACE FUNCTION setup_group_moderators()
RETURNS TRIGGER AS $$
DECLARE
  assigned_admin UUID;
BEGIN
  -- ุชุนููู ุตุงุญุจ ุงููุฌููุนุฉ ูู owner
  INSERT INTO group_members (group_id, user_id, role)
  VALUES (NEW.id, NEW.created_by, 'owner')
  ON CONFLICT (group_id, user_id) DO NOTHING;
  
  -- ุชุนููู ุฃุฏูู ููุดุฑู (ูููุฌููุนุงุช ุงููุฑุชุจุทุฉ ุจูุนุงููุฉ)
  IF NEW.event_id IS NOT NULL THEN
    assigned_admin := assign_admin_to_group();
    
    IF assigned_admin IS NOT NULL THEN
      NEW.assigned_admin_id := assigned_admin;
      
      INSERT INTO group_members (group_id, user_id, role)
      VALUES (NEW.id, assigned_admin, 'admin')
      ON CONFLICT (group_id, user_id) DO NOTHING;
    END IF;
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER SET search_path = public;
```

### 3. ุชุญุฏูุซุงุช ุงูููุฏ

#### `src/pages/Groups.tsx`:
- ุชุญุณูู ุฏุงูุฉ `handleJoinGroup` ููุชุนุงูู ูุน ุงููุฌููุนุงุช ุงูุฅูููููุฉ ูุงูุนุงุฏูุฉ
- ูุชุญ ุงููุฌููุนุฉ ุชููุงุฆูุงู ุจุนุฏ ุงูุงูุถูุงู
- ุฅุถุงูุฉ ุฒุฑ ุฏุฑุฏุดุฉ ูุฌููุน ุงููุฌููุนุงุช

#### `src/hooks/useGroupMessages.ts`:
- ุฅุตูุงุญ memory leak ูู cleanup function
- ุชุญุณูู ุฅุฏุงุฑุฉ ุงูุงุดุชุฑุงูุงุช ูู ุงูููุช ุงููุนูู

---

## ๐ ุงูุจูุงูุงุช ุงููุทุจูุฉ

### ุชู ุฅุถุงูุฉ ุงูููุธููู ุงูุญุงูููู:
```sql
INSERT INTO group_members (group_id, user_id, role)
SELECT eg.id, eg.created_by, 'owner'
FROM event_groups eg
WHERE NOT EXISTS (
  SELECT 1 FROM group_members gm 
  WHERE gm.group_id = eg.id 
  AND gm.user_id = eg.created_by
);
```

### ุชู ุฅุถุงูุฉ Unique Constraint:
```sql
ALTER TABLE group_members
ADD CONSTRAINT group_members_group_id_user_id_key 
UNIQUE (group_id, user_id);
```

---

## โ ุงูุงุฎุชุจุงุฑุงุช ุงููุทููุจุฉ

### 1. ุงุฎุชุจุงุฑ ุงููุฌููุนุงุช ุงูุฅูููููุฉ
- [ ] ุงูุฏุฎูู ูุตูุญุฉ ุงููุฌููุนุงุช
- [ ] ุฑุคูุฉ ุงููุฌููุนุงุช ุงูุฅูููููุฉ
- [ ] ุงูุงูุถูุงู ููุฌููุนุฉ ุฅูููููุฉ
- [ ] ุฅุฑุณุงู ุฑุณุงูุฉ ูู ุงููุฌููุนุฉ
- [ ] ุงุณุชูุจุงู ุฑุณุงุฆู ูู ุฃุนุถุงุก ุขุฎุฑูู

### 2. ุงุฎุชุจุงุฑ ูุฌููุนุงุช ุงููุนุงููุงุช
- [ ] ุฅูุดุงุก ูุนุงููุฉ ุฌุฏูุฏุฉ
- [ ] ุงูุชุญูู ูู ุธููุฑ ูุฌููุนุฉ ุงููุนุงููุฉ ุชููุงุฆูุงู
- [ ] ุฑุคูุฉ ููุณู ูุนุถู ูู ุงููุฌููุนุฉ
- [ ] ุฅุฑุณุงู ุฑุณุงูุฉ ูู ูุฌููุนุฉ ุงููุนุงููุฉ
- [ ] ุฏุนูุฉ ูุดุงุฑููู ุขุฎุฑูู

### 3. ุงุฎุชุจุงุฑ ุงูุตูุงุญูุงุช
- [ ] ุงูุชุญูู ูู ุฃู ุบูุฑ ุงูุฃุนุถุงุก ูุง ูุฑูู ุงูุฑุณุงุฆู
- [ ] ุงูุชุญูู ูู ุฃู ุบูุฑ ุงูุฃุนุถุงุก ูุง ูุณุชุทูุนูู ุงููุชุงุจุฉ
- [ ] ุงูุชุญูู ูู ุฃู ุงูููุธู ูุฏูู ุตูุงุญูุงุช owner
- [ ] ุงูุชุญูู ูู ุฃู ุงูุฃุฏูู ูุฏูู ุตูุงุญูุงุช admin

---

## ๐จ ุงูุชุญุณููุงุช ูู ุงููุงุฌูุฉ

1. **ุฒุฑ ุงูุงูุถูุงู**: ูุธูุฑ ูุฌููุน ุงููุฌููุนุงุช (ุฅูููููุฉ ูุนุงุฏูุฉ)
2. **ุฒุฑ ุงูุฏุฑุฏุดุฉ**: ูุธูุฑ ูุฌููุน ุงููุฌููุนุงุช ูููุชุญ ุงููุญุงุฏุซุฉ
3. **ูุชุญ ุชููุงุฆู**: ุจุนุฏ ุงูุงูุถูุงูุ ุชูุชุญ ุงููุฌููุนุฉ ุชููุงุฆูุงู
4. **ุฑุณุงุฆู ูุงุถุญุฉ**: ุชูุถูุญ ุญุงูุฉ ุงููุฌููุนุฉ (ููุชูุฆุฉุ ูุชุงุญุฉ ููุฌููุนุ ุฅูุฎ)

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุงูุฃูุงู**: ุฌููุน ุณูุงุณุงุช RLS ุชุชุทูุจ ุชุณุฌูู ุฏุฎูู (`authenticated`)
2. **ุงูุนุถููุฉ**: ูุฌุจ ุงูุงูุถูุงู ูููุฌููุนุฉ ูุจู ุงููุชุงุจุฉ ูููุง
3. **Realtime**: ุงูุฑุณุงุฆู ุชุตู ููุฑูุงู ูุฌููุน ุงูุฃุนุถุงุก
4. **ุงูุชูุธูู**: ุชู ุฅุตูุงุญ memory leaks ูู subscriptions

---

## ๐ ุงููุดุงูู ุงููุชุจููุฉ

ูุง ุชูุฌุฏ ูุดุงูู ูุนุฑููุฉ ุญุงููุงู. ุงููุธุงู ูุนูู ุจุดูู ูุงูู.

---

## ๐ ููุฏุนู

ุฅุฐุง ูุงุฌูุช ุฃู ูุดุงูู:
1. ุชุญูู ูู ุณุฌูุงุช Console
2. ุชุญูู ูู ุณุฌูุงุช Supabase
3. ุชุฃูุฏ ูู ุชุณุฌูู ุงูุฏุฎูู
4. ุชุฃูุฏ ูู ุงูุงูุถูุงู ูููุฌููุนุฉ ูุจู ุงููุชุงุจุฉ

---

**ุขุฎุฑ ุชุญุฏูุซ**: 2025-10-04
**ุงูุญุงูุฉ**: โ ููุชูู ูุฌุงูุฒ ููุงุณุชุฎุฏุงู
